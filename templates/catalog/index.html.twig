{% extends 'base.html.twig' %}

{% block title %}Catalog{% endblock %}

{% block body %}
    <div class="container mt-4 mt-md-5">

        <h1 class="mb-4 text-center">Catalog</h1>

        <div class="card shadow-sm p-4 mb-4">
            {{ form_start(searchForm) }}

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="form-group">
                        {{ form_label(searchForm.name) }}
                        {{ form_widget(searchForm.name, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(searchForm.name) }}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        {{ form_label(searchForm.shortDescription) }}
                        {{ form_widget(searchForm.shortDescription, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(searchForm.shortDescription) }}
                    </div>
                </div>
            </div>

            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    <div class="form-group">
                        {{ form_label(searchForm.minPrice) }}
                        {{ form_widget(searchForm.minPrice, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(searchForm.minPrice) }}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        {{ form_label(searchForm.maxPrice) }}
                        {{ form_widget(searchForm.maxPrice, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(searchForm.maxPrice) }}
                    </div>
                </div>
            </div>

            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    <div class="form-group">
                        {{ form_label(searchForm.stock) }}
                        {{ form_widget(searchForm.stock, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(searchForm.stock) }}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        {{ form_label(searchForm.category) }}
                        {{ form_widget(searchForm.category, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(searchForm.category) }}
                    </div>
                </div>
            </div>

            {% do searchForm.sku.setRendered() %}
            {% do searchForm.startDate.setRendered() %}
            {% do searchForm.endDate.setRendered() %}

            <button class="btn btn-primary mt-3">{{ button_label|default('Search') }}</button>

            {{ form_end(searchForm) }}
        </div>

        <div class="row g-4">
            {% for product in pagination %}
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="card h-100 shadow-sm">

                        <img src="{{ asset('uploads/products/' ~ product.image) }}"
                             class="card-img-top img-fluid"
                             style="object-fit: cover; height: 200px;"
                             alt="{{ product.name }}">

                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ product.name }}</h5>

                            <p class="text-muted small mb-1">
                                Short Description: {{ product.shortDescription }}
                            </p>

                            <p class="fw-bold mb-2">
                                {% if product.discountPrice and product.discountPrice > 0 %}
                                    <span class="text-muted text-decoration-line-through">
                                        {{ product.price|number_format(2, '.', ',') }} USD
                                    </span>
                                    <span class="text-danger ms-2">
                                        {{ product.getTotalPrice()|number_format(2, '.', ',') }} USD
                                    </span>
                                {% else %}
                                    {{ product.price|number_format(2, '.', ',') }} USD
                                {% endif %}
                            </p>

                            <p class="small mb-2">
                                Category: {{ product.category }}
                            </p>

                            <div class="mt-auto d-grid gap-2">
                                <a href="{{ path('catalog_show', { id: product.id, slug: product.slug }) }}"
                                   class="btn btn-outline-primary">
                                    View product
                                </a>

                                {% set isInCart = false %}
                                {% for item in cartItems %}
                                    {% if item.product.id == product.id %}
                                        {% set isInCart = true %}
                                    {% endif %}
                                {% endfor %}

                                {% if app.user and is_granted('ROLE_USER') %}
                                    {% if product.stock > 0 %}
                                        {% if isInCart %}
                                            <button class="btn btn-secondary" disabled>
                                                Already in Cart
                                            </button>
                                        {% else %}
                                            <a href="{{ path('cart_add', { id: product.id }) }}"
                                               class="btn btn-success">
                                                <i class="bi bi-cart-plus"></i> Add to Cart
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <button class="btn btn-secondary" disabled>
                                            Out of Stock
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        No products found.
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
{% endblock %}