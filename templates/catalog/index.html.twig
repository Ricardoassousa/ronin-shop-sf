{% extends 'base.html.twig' %}

{% block title %}Catalog{% endblock %}

{% block body %}
    <div class="container mt-4 mt-md-5">

        <h1 class="mb-4 text-center">Catalog</h1>

        <div class="card shadow-sm p-4 mb-4">
            {{ form_start(searchForm) }}

            <div class="row g-3">
                <div class="col-md-6">
                    {{ form_label(searchForm.name) }}
                    {{ form_widget(searchForm.name, {'attr': {'class': 'form-control'}}) }}
                    <div class="form-text text-muted small">
                        <i class="bi bi-info-circle me-1"></i>
                        Partial matches supported.
                    </div>
                </div>

                <div class="col-md-6">
                    {{ form_label(searchForm.shortDescription) }}
                    {{ form_widget(searchForm.shortDescription, {'attr': {'class': 'form-control'}}) }}
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <label class="form-label fw-semibold">Price Range</label>
                    <div id="price-slider"></div>

                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">
                            Min: $<span id="min-price"></span>
                        </small>
                        <small class="text-muted">
                            Max: $<span id="max-price"></span>
                        </small>
                    </div>
                </div>
            </div>

            {{ form_widget(searchForm.minPrice, {'attr': {'hidden': true}}) }}
            {{ form_widget(searchForm.maxPrice, {'attr': {'hidden': true}}) }}

            <div class="row g-3 mt-4">

                <div class="col-md-4">
                    {{ form_label(searchForm.category) }}
                    {{ form_widget(searchForm.category, {'attr': {'class': 'form-select'}}) }}
                </div>

                <div class="col-md-4">
                    {{ form_label(searchForm.availability) }}
                    {{ form_widget(searchForm.availability, {'attr': {'class': 'form-select'}}) }}
                </div>

                <div class="col-md-4">
                    {{ form_label(searchForm.sort) }}
                    {{ form_widget(searchForm.sort, {'attr': {'class': 'form-select'}}) }}
                </div>

            </div>

            <div class="row mt-4 align-items-center">
                <div class="col-md-6">
                    <div class="form-check">
                        {{ form_widget(searchForm.onSale, {'attr': {'class': 'form-check-input'}}) }}
                        {{ form_label(searchForm.onSale, null, {'label_attr': {'class': 'form-check-label'}}) }}
                    </div>
                </div>

                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <button class="btn btn-primary px-4">
                        <i class="bi bi-search me-1"></i>
                        {{ button_label|default('Search') }}
                    </button>
                </div>
            </div>

            {% do searchForm.sku.setRendered() %}
            {% do searchForm.startDate.setRendered() %}
            {% do searchForm.endDate.setRendered() %}

            {{ form_end(searchForm) }}
        </div>

        <div class="row g-4">
            {% for product in pagination %}
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="card h-100 shadow-sm">

                        <img src="{{ asset('uploads/products/' ~ product.image) }}"
                             class="card-img-top img-fluid"
                             style="object-fit: cover; height: 200px;"
                             alt="{{ product.name }}">

                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ product.name }}</h5>

                            <p class="text-muted small mb-1">
                                Short Description: {{ product.shortDescription }}
                            </p>

                            <p class="fw-bold mb-2">
                                {% if product.discountPrice and product.discountPrice > 0 %}
                                    <span class="text-muted text-decoration-line-through">
                                        ${{ product.price|number_format(2, '.', ',') }}
                                    </span>
                                    <span class="text-danger ms-2">
                                        ${{ product.finalPrice|number_format(2, '.', ',') }}
                                    </span>
                                {% else %}
                                    ${{ product.price|number_format(2, '.', ',') }}
                                {% endif %}
                            </p>

                            <p class="small mb-2">
                                Category: {{ product.category }}
                            </p>

                            <div class="mt-auto d-grid gap-2">
                                <a href="{{ path('catalog_show', { id: product.id, slug: product.slug }) }}"
                                   class="btn btn-outline-primary">
                                    View product
                                </a>

                                {% set isInCart = false %}
                                {% for item in cartItems %}
                                    {% if item.product.id == product.id %}
                                        {% set isInCart = true %}
                                    {% endif %}
                                {% endfor %}

                                {% if app.user and is_granted('ROLE_USER') %}
                                    {% if product.stock > 0 %}
                                        {% if isInCart %}
                                            <button class="btn btn-secondary" disabled>
                                                Already in Cart
                                            </button>
                                        {% else %}
                                            <a href="{{ path('cart_add', { id: product.id }) }}"
                                               class="btn btn-success">
                                                <i class="bi bi-cart-plus"></i> Add to Cart
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <button class="btn btn-secondary" disabled>
                                            Out of Stock
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        No products found.
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            var slider = document.getElementById('price-slider');

            if (!slider || typeof noUiSlider === 'undefined') {
                return;
            }

            var minInput = document.getElementById('{{ searchForm.minPrice.vars.id }}');
            var maxInput = document.getElementById('{{ searchForm.maxPrice.vars.id }}');

            var minDisplay = document.getElementById('min-price');
            var maxDisplay = document.getElementById('max-price');

            var startMin = minInput.value ? parseInt(minInput.value) : 0;
            var startMax = maxInput.value ? parseInt(maxInput.value) : 1000;

            noUiSlider.create(slider, {
                start: [startMin, startMax],
                connect: true,
                step: 10,
                range: {
                    'min': 0,
                    'max': 1000
                }
            });

            slider.noUiSlider.on('update', function (values) {

                var min = Math.round(values[0]);
                var max = Math.round(values[1]);

                minInput.value = min;
                maxInput.value = max;

                minDisplay.innerText = min;
                maxDisplay.innerText = max;
            });

        });
    </script>
{% endblock %}