{% extends 'base.html.twig' %}

{% block title %}Products{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block body %}
    <div class="container mt-4">
        <h1>Products</h1>

        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        <div class="card shadow-sm p-4 mb-4">
            {{ form_start(searchForm) }}

            <div class="row g-3">
                <div class="col-md-6">
                    {{ form_label(searchForm.name) }}
                    {{ form_widget(searchForm.name, {'attr': {'class': 'form-control'}}) }}
                </div>

                <div class="col-md-6">
                    {{ form_label(searchForm.sku) }}
                    {{ form_widget(searchForm.sku, {'attr': {'class': 'form-control'}}) }}
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <label class="form-label fw-semibold">Price Range</label>

                    <div id="price-slider"></div>

                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-muted">
                            Min: $<span id="min-price"></span>
                        </small>
                        <small class="text-muted">
                            Max: $<span id="max-price"></span>
                        </small>
                    </div>
                </div>
            </div>

            {{ form_widget(searchForm.minPrice, {'attr': {'hidden': true}}) }}
            {{ form_widget(searchForm.maxPrice, {'attr': {'hidden': true}}) }}

            <div class="row g-3 mt-3">
                <div class="col-md-4">
                    {{ form_label(searchForm.category) }}
                    {{ form_widget(searchForm.category, {'attr': {'class': 'form-select'}}) }}
                </div>

                <div class="col-md-4">
                    {{ form_label(searchForm.startDate) }}
                    {{ form_widget(searchForm.startDate, {'attr': {'class': 'form-control'}}) }}
                </div>

                <div class="col-md-4">
                    {{ form_label(searchForm.endDate) }}
                    {{ form_widget(searchForm.endDate, {'attr': {'class': 'form-control'}}) }}
                </div>
            </div>

            <div class="row g-3 mt-3">
                <div class="col-md-4">
                    {{ form_label(searchForm.availability) }}
                    {{ form_widget(searchForm.availability, {'attr': {'class': 'form-select'}}) }}
                </div>

                <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check">
                        {{ form_widget(searchForm.onSale, {'attr': {'class': 'form-check-input'}}) }}
                        {{ form_label(searchForm.onSale, null, {'label_attr': {'class': 'form-check-label'}}) }}
                    </div>
                </div>

                <div class="col-md-4">
                    {{ form_label(searchForm.sort) }}
                    {{ form_widget(searchForm.sort, {'attr': {'class': 'form-select'}}) }}
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12 text-end">
                    <button class="btn btn-primary px-4">
                        <i class="bi bi-search me-1"></i>
                        {{ button_label|default('Search') }}
                    </button>
                </div>
            </div>

            {% do searchForm.shortDescription.setRendered() %}

            {{ form_end(searchForm) }}
        </div>

        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>SKU</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Category</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in pagination %}
                    <tr>
                        <td>{{ product.id }}</td>
                        <td>{{ product.name }}</td>
                        <td>{{ product.sku }}</td>
                        <td class="fw-bold">
                            {% if product.discountPrice and product.discountPrice > 0 %}
                                <div>
                                    <span class="text-muted text-decoration-line-through small">
                                        ${{ product.price|number_format(2, '.', ',') }}
                                    </span>
                                </div>
                                <div class="text-danger">
                                    ${{ product.finalPrice|number_format(2, '.', ',') }}
                                </div>
                            {% else %}
                                ${{ product.price|number_format(2, '.', ',') }}
                            {% endif %}
                        </td>
                        <td>{{ product.stock ?: 'N/A' }}</td>
                        <td>{{ product.category }}</td>
                        <td>{{ product.createdAt|date('Y-m-d') }}</td>
                        <td>
                            <a href="{{ path('product_show', { id: product.id, slug: product.slug }) }}" class="btn btn-sm btn-info">Show</a>
                            <a href="{{ path('product_edit', { id: product.id }) }}" class="btn btn-sm btn-warning">Edit</a>
                            <form action="{{ path('product_delete', { id: product.id }) }}" method="post" style="display:inline-block">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ product.id) }}">
                                <input type="hidden" name="_method" value="DELETE">
                                <button class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center">No products found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="d-flex justify-content-center mt-4">
            {{ knp_pagination_render(pagination) }}
        </div>

        <a href="{{ path('product_new') }}" class="btn btn-primary mb-3">Create New Product</a>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            var slider = document.getElementById('price-slider');

            if (!slider || typeof noUiSlider === 'undefined') {
                return;
            }

            var minInput = document.getElementById('{{ searchForm.minPrice.vars.id }}');
            var maxInput = document.getElementById('{{ searchForm.maxPrice.vars.id }}');

            var minDisplay = document.getElementById('min-price');
            var maxDisplay = document.getElementById('max-price');

            var startMin = minInput.value ? parseInt(minInput.value) : 0;
            var startMax = maxInput.value ? parseInt(maxInput.value) : 1000;

            noUiSlider.create(slider, {
                start: [startMin, startMax],
                connect: true,
                step: 10,
                range: {
                    'min': 0,
                    'max': 1000
                }
            });

            slider.noUiSlider.on('update', function (values) {

                var min = Math.round(values[0]);
                var max = Math.round(values[1]);

                minInput.value = min;
                maxInput.value = max;

                minDisplay.innerText = min;
                maxDisplay.innerText = max;
            });

        });
    </script>
{% endblock %}